services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: daily-tasks-tracker-app
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_HOST=mariadb
      - DATABASE_PORT=3306
      - DATABASE_NAME=${DATABASE_NAME:-daily_tasks}
      - DATABASE_USER=${DATABASE_USER:-daily_tasks_user}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_URL=mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@mariadb:3306/${DATABASE_NAME}
    depends_on:
      mariadb:
        condition: service_healthy
    networks:
      - daily-tasks-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mariadb:
    image: mariadb:11.3
    container_name: daily-tasks-tracker-db
    # Port 3306 is NOT mapped to the host for production security.
    # It remains accessible within the daily-tasks-network.
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DATABASE_NAME:-daily_tasks}
      - MYSQL_USER=${DATABASE_USER:-daily_tasks_user}
      - MYSQL_PASSWORD=${DATABASE_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - daily-tasks-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  daily-tasks-network:
    driver: bridge

volumes:
  mariadb_data:
    driver: local
